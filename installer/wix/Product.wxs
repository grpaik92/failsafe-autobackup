<?xml version="1.0" encoding="UTF-8"?>
<!--
    Failsafe AutoBackup Installer - WiX Source File
    
    This WiX installer packages the Failsafe AutoBackup application with:
    - Windows Service (FailsafeAutoBackup.Service)
    - Tray Application (FailsafeAutoBackup.TrayApp)
    - Start Menu and Desktop shortcuts
    - Automatic service installation and startup
    
    To build the installer:
    1. Install WiX Toolset v4 or later
    2. Run: wix build Product.wxs -ext WixToolset.UI.wixext -out FailsafeAutoBackup.msi
-->

<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
     xmlns:util="http://wixtoolset.org/schemas/v4/wxs/util">
    
    <Package 
        Name="Failsafe AutoBackup" 
        Version="1.0.0.0" 
        Manufacturer="Failsafe AutoBackup Team" 
        UpgradeCode="C33254F0-25AF-4342-95AD-D74F2D726684"
        Language="1033"
        InstallerVersion="500"
        Compressed="yes">
        
        <SummaryInformation 
            Description="Automatic document backup service for Microsoft Word and PDF documents"
            Comments="Installs Failsafe AutoBackup Windows Service and Tray Application"
            Manufacturer="Failsafe AutoBackup Team" />

        <!-- Media definition -->
        <Media Id="1" Cabinet="product.cab" EmbedCab="yes" />

        <!-- Major upgrade configuration -->
        <MajorUpgrade 
            DowngradeErrorMessage="A newer version of [ProductName] is already installed."
            AllowSameVersionUpgrades="yes" />

        <!-- Installation directory structure -->
        <StandardDirectory Id="ProgramFiles64Folder">
            <Directory Id="INSTALLFOLDER" Name="FailsafeAutoBackup">
                <!-- Service subdirectory -->
                <Directory Id="ServiceFolder" Name="Service" />
                
                <!-- Tray App subdirectory -->
                <Directory Id="TrayAppFolder" Name="TrayApp" />
            </Directory>
        </StandardDirectory>

        <!-- ProgramData for logs and configuration -->
        <StandardDirectory Id="CommonAppDataFolder">
            <Directory Id="AppDataFolder" Name="FailsafeAutoBackup">
                <Directory Id="LogsFolder" Name="Logs" />
            </Directory>
        </StandardDirectory>

        <!-- Desktop shortcut -->
        <StandardDirectory Id="DesktopFolder" />

        <!-- Start Menu -->
        <StandardDirectory Id="ProgramMenuFolder">
            <Directory Id="ApplicationProgramsFolder" Name="Failsafe AutoBackup" />
        </StandardDirectory>

        <!-- Component: Windows Service Executable -->
        <Component Id="ServiceExecutable" Directory="ServiceFolder" Guid="BF11B56D-0EFA-4112-8F04-A1B76382CA01">
            <File Id="ServiceExe" Source="..\..\publish\service\FailsafeAutoBackup.Service.exe" KeyPath="yes" />
            
            <!-- Install Windows Service -->
            <ServiceInstall
                Id="FailsafeAutoBackupServiceInstall"
                Name="FailsafeAutoBackupService"
                DisplayName="Failsafe AutoBackup Service"
                Description="Automatic backup service for Microsoft Word and PDF documents"
                Type="ownProcess"
                Start="auto"
                Account="LocalSystem"
                ErrorControl="normal"
                Interactive="no">
                <ServiceConfig
                    FirstFailureActionType="restart"
                    SecondFailureActionType="restart"
                    ThirdFailureActionType="restart"
                    RestartServiceDelayInSeconds="60"
                    ResetPeriodInDays="1" />
            </ServiceInstall>
            
            <!-- Control service on install/uninstall -->
            <ServiceControl
                Id="StartFailsafeAutoBackupService"
                Name="FailsafeAutoBackupService"
                Start="install"
                Stop="both"
                Remove="uninstall"
                Wait="yes" />
        </Component>

        <!-- Component: Tray Application Executable -->
        <Component Id="TrayAppExecutable" Directory="TrayAppFolder" Guid="829DC472-33C0-48E6-A53E-BAD518AA6AAB">
            <File Id="TrayAppExe" Source="..\..\publish\trayapp\FailsafeAutoBackup.TrayApp.exe" KeyPath="yes" />
        </Component>

        <!-- Component: Logs Directory -->
        <Component Id="LogsDirectory" Directory="LogsFolder" Guid="EC4045AF-6D87-4044-9939-1B8116A37DBE">
            <CreateFolder />
            <RemoveFolder Id="RemoveLogsFolder" On="uninstall" />
        </Component>

        <!-- Component: Start Menu Shortcut -->
        <Component Id="StartMenuShortcut" Directory="ApplicationProgramsFolder" Guid="123687ED-81E1-4DD0-AC5F-1DB3533545FF">
            <Shortcut
                Id="TrayAppStartMenuShortcut"
                Name="Failsafe AutoBackup"
                Description="Automatic document backup for Word and PDF"
                Target="[TrayAppFolder]FailsafeAutoBackup.TrayApp.exe"
                WorkingDirectory="TrayAppFolder" />
            <RemoveFolder Id="RemoveApplicationProgramsFolder" On="uninstall" />
            <RegistryValue Root="HKCU" Key="Software\FailsafeAutoBackup\Installed" Name="StartMenu" Type="integer" Value="1" KeyPath="yes" />
        </Component>

        <!-- Component: Desktop Shortcut (Optional) -->
        <Component Id="DesktopShortcut" Directory="DesktopFolder" Guid="1A197F99-A77D-4127-9FF6-EBF51CDB6293">
            <Shortcut
                Id="TrayAppDesktopShortcut"
                Name="Failsafe AutoBackup"
                Description="Automatic document backup for Word and PDF"
                Target="[TrayAppFolder]FailsafeAutoBackup.TrayApp.exe"
                WorkingDirectory="TrayAppFolder" />
            <RegistryValue Root="HKCU" Key="Software\FailsafeAutoBackup\Installed" Name="Desktop" Type="integer" Value="1" KeyPath="yes" />
        </Component>

        <!-- Component: Auto-start Registry Entry -->
        <Component Id="AutoStartRegistry" Directory="INSTALLFOLDER" Guid="04BAFCC4-2ACE-409D-A499-FB95D852C4D3">
            <RegistryValue
                Root="HKCU"
                Key="Software\Microsoft\Windows\CurrentVersion\Run"
                Name="FailsafeAutoBackup"
                Value="[TrayAppFolder]FailsafeAutoBackup.TrayApp.exe"
                Type="string"
                KeyPath="yes" />
        </Component>

        <!-- Feature: Main application -->
        <Feature Id="MainApplication" 
                 Title="Failsafe AutoBackup" 
                 Level="1" 
                 Description="Core application files and Windows service"
                 Display="expand"
                 ConfigurableDirectory="INSTALLFOLDER">
            <ComponentRef Id="ServiceExecutable" />
            <ComponentRef Id="TrayAppExecutable" />
            <ComponentRef Id="LogsDirectory" />
            <ComponentRef Id="StartMenuShortcut" />
            <ComponentRef Id="AutoStartRegistry" />
        </Feature>

        <!-- Feature: Desktop shortcut (Optional) -->
        <Feature Id="DesktopShortcutFeature" 
                 Title="Desktop Shortcut" 
                 Level="1" 
                 Description="Creates a desktop shortcut for easy access">
            <ComponentRef Id="DesktopShortcut" />
        </Feature>

        <!-- UI Configuration -->
        <Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER" />
        <UIRef Id="WixUI_InstallDir" />
        <UIRef Id="WixUI_ErrorProgressText" />

        <!-- License agreement -->
        <WixVariable Id="WixUILicenseRtf" Value="License.rtf" />

    </Package>
</Wix>
